<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KasiFix ‚Äì Find Trusted Local Help in Your Kasi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase v8 (compat mode) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif;
        }
        
        .heading-font {
            font-family: 'Poppins', sans-serif;
        }

        .hero-bg {
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px -10px rgba(249, 115, 22, 0.25);
        }

        .pill-btn {
            border-radius: 9999px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .pill-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(249, 115, 22, 0.4);
        }
        .pill-btn:active {
            transform: scale(0.97);
        }
        .pill-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s;
        }
        .pill-btn:hover::after {
            transform: translateX(100%);
        }

        .search-container {
            position: relative;
            max-width: 1100px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border-radius: 9999px;
            padding: 8px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
            border: 1px solid rgba(249,115,34,0.1);
        }

        .search-input {
            background: transparent;
            border: none;
            color: #111827;
        }

        .search-input::placeholder {
            color: #9ca3af;
        }

        .input-wrapper {
            background: white;
            border-radius: 9999px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .input-wrapper:focus-within {
            border-color: #f97316;
            box-shadow: 0 0 0 4px rgba(249, 115, 34, 0.15);
            transform: scale(1.015);
        }

        .advanced-panel {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            max-height: 0;
            overflow: hidden;
            opacity: 0;
        }
        .advanced-panel.open {
            max-height: 500px;
            opacity: 1;
        }

        .modal-backdrop {
            backdrop-filter: blur(8px);
            background: rgba(0,0,0,0.65);
        }
        .modal-content {
            transform: scale(0.92);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-backdrop:not(.hidden) .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .dropdown:hover .dropdown-menu {
            display: block;
        }
        .dropdown-menu {
            display: none;
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            min-width: 220px;
            max-height: 320px;
            overflow-y: auto;
            z-index: 50;
            margin-top: 8px;
        }

        .dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .dropdown-item:hover {
            background: #f97316;
            color: white;
        }

        .progress-container {
            height: 6px;
            background: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f97316, #fb923c);
            transition: width 0.2s ease;
        }

        /* Dashboard full page styling */
        #admin-dashboard-page, #hustler-dashboard-page {
            display: none;
            min-height: 100vh;
            background: linear-gradient(to bottom, #f8fafc, #e5e7eb);
        }

        #main-content.hidden {
            display: none;
        }

        .rating-stars {
            color: #f59e0b;
        }

        .reviews-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .review-item {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        /* Categories Section */
        .category-card {
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border: 1px solid #f1f5f9;
        }

        .category-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 30px rgba(249, 115, 34, 0.18);
        }

        .category-icon {
            font-size: 2.5rem;
            color: #f97316;
        }

        /* Dashboard Stats Cards */
        .stat-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(249, 115, 34, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1rem;
        }

        .chart-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #f1f5f9;
        }

        /* Enhanced Dashboard Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-slide-in {
            animation: slideInUp 0.5s ease-out forwards;
        }

        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }
        .stagger-4 { animation-delay: 0.4s; opacity: 0; }
    </style>
</head>
<body class="bg-gray-50">

    <div id="main-content">

        <!-- Navigation -->
        <nav class="bg-white border-b sticky top-0 z-50 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center cursor-pointer" onclick="window.location.href='index.html'">
                        <span class="text-2xl font-extrabold heading-font text-[#1e3a8a]">Kasi<span class="text-[#f97316]">Fix</span></span>
                    </div>
                    <div class="hidden md:flex items-center space-x-8">
                        <a href="#all-hustlers" class="text-gray-700 hover:text-[#1e3a8a] font-medium">Find Help</a>
                        <button onclick="document.getElementById('hustler-signup-modal').classList.remove('hidden')"
                                class="pill-btn bg-[#f97316] text-white px-6 py-2.5 font-bold hover:bg-orange-600 transition shadow">
                            Become a Hustler
                        </button>
                        <button id="hustler-login-btn" class="pill-btn bg-blue-600 text-white px-6 py-2.5 font-bold hover:bg-blue-700 transition shadow ml-3">
                            Hustler Login
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero -->
        <section class="hero-bg text-white py-24 md:py-32">
            <div class="max-w-6xl mx-auto px-4 text-center">
                <h1 class="text-4xl md:text-6xl font-extrabold heading-font mb-6 leading-tight">
                    Find Trusted Local Help<br/>Right in Your Kasi
                </h1>
                <p class="text-xl md:text-2xl text-blue-100 mb-10 max-w-3xl mx-auto">
                    Plumbers, electricians, car washers, barbers, builders ‚Äî real people, real skills, real fast.
                </p>

                <div class="search-container">
                    <div class="flex flex-col md:flex-row gap-3">
                        <div class="flex-1 input-wrapper flex items-center px-5 py-3">
                            <i class="fa-solid fa-search text-gray-400 mr-3 text-xl"></i>
                            <input type="text" id="search-keyword" placeholder="Plumber in Soweto, barber..." 
                                   class="search-input flex-1 text-lg outline-none" oninput="filterHustlers()">
                        </div>
                        <div class="md:w-64 input-wrapper flex items-center px-5 py-3">
                            <i class="fa-solid fa-location-dot text-gray-400 mr-3 text-xl"></i>
                            <input type="text" id="search-location" placeholder="Location (e.g. Soweto)" 
                                   class="search-input flex-1 text-lg outline-none" value="Johannesburg" oninput="filterHustlers()">
                        </div>
                        <button onclick="document.getElementById('advanced-panel').classList.toggle('open')"
                                class="pill-btn bg-white text-gray-800 px-6 py-3 font-medium hover:bg-gray-100 transition shadow flex items-center justify-center min-w-[140px]">
                            <i class="fa-solid fa-sliders mr-2"></i> Advanced
                        </button>
                    </div>

                    <div id="advanced-panel" class="advanced-panel mt-4 px-2">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 bg-white/80 backdrop-blur-sm p-5 rounded-2xl border border-gray-100">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                                <select id="search-category" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none bg-white" onchange="filterHustlers()">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Min Hourly Rate (R)</label>
                                <input type="number" id="search-min-rate" min="0" placeholder="e.g. 150" 
                                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-[#f97316] outline-none bg-white" oninput="filterHustlers()">
                            </div>
                            <div class="flex items-end">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" id="search-verified-only" class="w-5 h-5 text-[#f97316] border-gray-300 rounded focus:ring-[#f97316]" onchange="filterHustlers()" checked>
                                    <span class="ml-3 text-gray-700 font-medium">Verified hustlers only</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-center gap-5 mt-10 max-w-xl mx-auto">
                    <a href="#all-hustlers" 
                       class="pill-btn border-2 border-white text-white px-10 py-5 text-lg font-bold hover:bg-white hover:text-[#1e3a8a] transition shadow-lg">
                        Browse All Hustlers
                    </a>
                </div>
            </div>
        </section>

        <!-- Categories Section -->
        <section id="categories" class="py-16 bg-gray-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-extrabold heading-font text-center mb-12 text-gray-900">Popular Categories</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Plumbing')">
                        <div class="category-icon mb-4"><i class="fas fa-tools"></i></div>
                        <h3 class="font-bold text-lg mb-1">Plumbing</h3>
                        <p class="text-sm text-gray-600">Leaky pipes, geysers, toilets</p>
                    </div>

                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Electrical')">
                        <div class="category-icon mb-4"><i class="fas fa-bolt"></i></div>
                        <h3 class="font-bold text-lg mb-1">Electrical</h3>
                        <p class="text-sm text-gray-600">Wiring, lights, inverters</p>
                    </div>

                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Barber')">
                        <div class="category-icon mb-4"><i class="fas fa-cut"></i></div>
                        <h3 class="font-bold text-lg mb-1">Barber</h3>
                        <p class="text-sm text-gray-600">Haircuts, fades, shaves</p>
                    </div>

                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Cleaning')">
                        <div class="category-icon mb-4"><i class="fas fa-broom"></i></div>
                        <h3 class="font-bold text-lg mb-1">Cleaning</h3>
                        <p class="text-sm text-gray-600">House, car, office cleaning</p>
                    </div>

                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Solar')">
                        <div class="category-icon mb-4"><i class="fas fa-solar-panel"></i></div>
                        <h3 class="font-bold text-lg mb-1">Solar</h3>
                        <p class="text-sm text-gray-600">Installation & repairs</p>
                    </div>

                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Building')">
                        <div class="category-icon mb-4"><i class="fas fa-hard-hat"></i></div>
                        <h3 class="font-bold text-lg mb-1">Building</h3>
                        <p class="text-sm text-gray-600">Bricklaying, plastering</p>
                    </div>

                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Car Wash')">
                        <div class="category-icon mb-4"><i class="fas fa-car"></i></div>
                        <h3 class="font-bold text-lg mb-1">Car Wash</h3>
                        <p class="text-sm text-gray-600">Mobile & detailing</p>
                    </div>

                    <div class="category-card p-6 text-center" onclick="showFirstHustlerInCategory('Painting')">
                        <div class="category-icon mb-4"><i class="fas fa-paint-roller"></i></div>
                        <h3 class="font-bold text-lg mb-1">Painting</h3>
                        <p class="text-sm text-gray-600">Interior & exterior</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- All Hustlers -->
        <section id="all-hustlers" class="py-20 bg-gray-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <h2 class="text-3xl md:text-4xl font-extrabold heading-font text-center mb-12 text-gray-900">Find Hustlers Near You</h2>
                <div id="hustlers-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="bg-[#1e3a8a] text-white py-12">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div>
                        <h3 class="text-xl font-bold heading-font mb-4">KasiFix</h3>
                        <p class="text-blue-100">Real skills. Real people. Right in your kasi.</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Quick Links</h3>
                        <ul class="space-y-2">
                            <li><a href="#all-hustlers" class="hover:text-[#f97316]">Find Help</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Support</h3>
                        <ul class="space-y-2">
                            <li><a href="#" class="hover:text-[#f97316]">FAQ</a></li>
                            <li><a href="#" class="hover:text-[#f97316]">Contact</a></li>
                            <li><a href="#" class="hover:text-[#f97316]">Privacy Policy</a></li>
                            <li><a href="#" class="hover:text-[#f97316]">Terms</a></li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Follow Us</h3>
                        <div class="flex space-x-4 text-2xl">
                            <a href="#" class="hover:text-[#f97316]"><i class="fab fa-facebook-f"></i></a>
                            <a href="#" class="hover:text-[#f97316]"><i class="fab fa-twitter"></i></a>
                            <a href="#" class="hover:text-[#f97316]"><i class="fab fa-instagram"></i></a>
                        </div>
                    </div>
                </div>
                <div class="mt-12 pt-8 border-t border-blue-800 text-center text-blue-200">
                    ¬© 2026 KasiFix. Built for the community.
                </div>
            </div>
        </footer>

        <!-- Hustler Detail Modal -->
        <div id="hustler-detail-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 hidden">
            <div class="modal-content bg-white rounded-3xl p-8 max-w-2xl w-full m-6 relative max-h-[90vh] overflow-y-auto shadow-2xl border border-gray-100">
                <button onclick="document.getElementById('hustler-detail-modal').classList.add('hidden')"
                        class="absolute top-5 right-5 text-gray-500 hover:text-gray-800 transition">
                    <i class="fa-solid fa-times text-2xl"></i>
                </button>
                <div id="hustler-detail-content"></div>
                <div id="reviews-section" class="mt-8">
                    <h3 class="text-xl font-bold mb-4">Reviews</h3>
                    <div id="reviews-list" class="reviews-list mb-6"></div>
                    <h4 class="text-lg font-semibold mb-3">Leave a Review</h4>
                    <form id="review-form" class="space-y-4">
                        <div class="flex items-center">
                            <div class="rating-stars flex text-2xl mr-4" id="review-rating">
                                <i class="fa-regular fa-star cursor-pointer" data-rating="1"></i>
                                <i class="fa-regular fa-star cursor-pointer" data-rating="2"></i>
                                <i class="fa-regular fa-star cursor-pointer" data-rating="3"></i>
                                <i class="fa-regular fa-star cursor-pointer" data-rating="4"></i>
                                <i class="fa-regular fa-star cursor-pointer" data-rating="5"></i>
                            </div>
                            <input type="hidden" id="selected-rating" value="0">
                        </div>
                        <textarea id="review-comment" placeholder="Write your review..." rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition"></textarea>
                        <input id="review-name" placeholder="Your name (optional)" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition">
                        <button type="submit" class="pill-btn w-full bg-[#f97316] text-white py-3.5 rounded-full font-bold hover:bg-orange-600 transition shadow">
                            Submit Review
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Become a Hustler Modal -->
        <div id="hustler-signup-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 hidden">
            <div class="modal-content bg-white rounded-3xl p-7 max-w-md w-full m-6 relative max-h-[90vh] overflow-y-auto shadow-2xl border border-gray-100">
                <button onclick="document.getElementById('hustler-signup-modal').classList.add('hidden')"
                        class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
                <h2 class="text-2xl font-bold heading-font mb-6 text-center text-gray-900">Become a Hustler</h2>
                <form id="hustler-signup-form" class="space-y-4 text-sm">
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Full Name *</label>
                        <input type="text" name="name" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Email *</label>
                        <input type="email" name="email" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Phone Number (with +27) *</label>
                        <input type="tel" name="phone" required placeholder="+27123456789" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Category / Service *</label>
                        <input type="text" name="category" required placeholder="e.g. Plumbing, Barber" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Hourly Rate (R) *</label>
                        <input type="number" name="rate" required min="50" placeholder="150" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Location (e.g. Soweto) *</label>
                        <input type="text" name="location" required class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Short Bio</label>
                        <textarea name="bio" rows="3" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-[#f97316] outline-none transition"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1 font-medium">Profile Photo</label>
                        <input type="file" id="profile-photo" accept="image/*" class="w-full px-3 py-2 rounded-lg border border-gray-200">
                        
                        <div id="progress-container" class="progress-container hidden mt-2">
                            <div id="progress-bar" class="progress-bar"></div>
                        </div>
                        <p id="progress-text" class="text-xs text-gray-600 mt-1 text-center hidden">Uploading...</p>

                        <div id="photo-preview" class="mt-3 hidden">
                            <img id="preview-img" class="w-20 h-20 object-cover rounded-xl mx-auto shadow-sm" alt="Preview">
                            <p class="text-xs text-gray-500 mt-1 text-center">Uploaded successfully</p>
                        </div>
                        <input type="hidden" name="imageUrl" id="imageUrlField">
                    </div>
                    <button type="submit" class="pill-btn w-full bg-[#f97316] text-white py-3.5 rounded-full font-bold hover:bg-orange-600 transition shadow mt-2">
                        Submit & Join KasiFix
                    </button>
                </form>
            </div>
        </div>

    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard-page" class="bg-gradient-to-b from-gray-50 to-gray-100">
        <nav class="bg-white border-b shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <span class="text-2xl font-extrabold heading-font text-[#1e3a8a]">Kasi<span class="text-[#f97316]">Fix</span> Admin</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button onclick="goBackToHome()"
                                class="pill-btn bg-gray-700 text-white px-6 py-2 font-medium hover:bg-gray-800 transition">
                            Back to Home
                        </button>
                        <button onclick="firebase.auth().signOut().then(goBackToHome)"
                                class="pill-btn bg-red-600 text-white px-6 py-2 font-medium hover:bg-red-700 transition">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <h1 class="text-3xl font-bold heading-font text-gray-900 mb-8">Pending Hustler Applications</h1>

            <div id="pending-hustlers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dynamically populated -->
            </div>

            <div class="mt-12 text-center text-gray-500">
                <p>Note: Only unverified (pending) hustlers are shown here for admin review.</p>
            </div>
        </main>
    </div>

    <!-- Hustler Dashboard -->
    <div id="hustler-dashboard-page">
        <nav class="bg-white border-b shadow-sm sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center">
                        <span class="text-2xl font-extrabold heading-font text-[#1e3a8a]">Kasi<span class="text-[#f97316]">Fix</span> Dashboard</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="hustler-name-nav" class="text-gray-700 font-medium hidden md:block"></span>
                        <button onclick="goBackToHome()"
                                class="pill-btn bg-gray-700 text-white px-6 py-2 font-medium hover:bg-gray-800 transition">
                            Back to Home
                        </button>
                        <button onclick="firebase.auth().signOut().then(goBackToHome)"
                                class="pill-btn bg-red-600 text-white px-6 py-2 font-medium hover:bg-red-700 transition">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <!-- Welcome Section -->
            <div class="mb-10">
                <h1 class="text-4xl font-bold heading-font text-gray-900 mb-2">Welcome back, <span id="hustler-name-header"></span>! üëã</h1>
                <p class="text-gray-600 text-lg">Here's how your business is performing</p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="stat-card animate-slide-in stagger-1">
                    <div class="stat-icon bg-blue-100 text-blue-600">
                        <i class="fas fa-eye"></i>
                    </div>
                    <h3 class="text-gray-600 text-sm font-medium mb-1">Profile Views</h3>
                    <p class="text-3xl font-bold heading-font text-gray-900" id="stat-views">0</p>
                    <p class="text-sm text-green-600 mt-2">
                        <i class="fas fa-arrow-up"></i> <span id="views-change">0%</span> vs last month
                    </p>
                </div>

                <div class="stat-card animate-slide-in stagger-2">
                    <div class="stat-icon bg-green-100 text-green-600">
                        <i class="fas fa-star"></i>
                    </div>
                    <h3 class="text-gray-600 text-sm font-medium mb-1">Average Rating</h3>
                    <p class="text-3xl font-bold heading-font text-gray-900" id="stat-rating">0.0</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Based on <span id="total-reviews">0</span> reviews
                    </p>
                </div>

                <div class="stat-card animate-slide-in stagger-3">
                    <div class="stat-icon bg-orange-100 text-orange-600">
                        <i class="fas fa-phone"></i>
                    </div>
                    <h3 class="text-gray-600 text-sm font-medium mb-1">Contact Clicks</h3>
                    <p class="text-3xl font-bold heading-font text-gray-900" id="stat-contacts">0</p>
                    <p class="text-sm text-green-600 mt-2">
                        <i class="fas fa-arrow-up"></i> <span id="contacts-change">0%</span> this week
                    </p>
                </div>

                <div class="stat-card animate-slide-in stagger-4">
                    <div class="stat-icon bg-purple-100 text-purple-600">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <h3 class="text-gray-600 text-sm font-medium mb-1">Rank in Category</h3>
                    <p class="text-3xl font-bold heading-font text-gray-900" id="stat-rank">#-</p>
                    <p class="text-sm text-gray-600 mt-2">
                        Out of <span id="category-total">0</span> hustlers
                    </p>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-10">
                <div class="chart-container">
                    <h3 class="text-xl font-bold heading-font text-gray-900 mb-6">Weekly Performance</h3>
                    <canvas id="weeklyChart" height="250"></canvas>
                </div>

                <div class="chart-container">
                    <h3 class="text-xl font-bold heading-font text-gray-900 mb-6">Rating Distribution</h3>
                    <canvas id="ratingChart" height="250"></canvas>
                </div>
            </div>

            <!-- Profile & Reviews Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Profile Card -->
                <div class="chart-container lg:col-span-1">
                    <h3 class="text-xl font-bold heading-font text-gray-900 mb-6">Your Profile</h3>
                    <div class="text-center mb-6">
                        <img id="dashboard-profile-pic" class="w-32 h-32 rounded-full object-cover mx-auto ring-4 ring-orange-100 mb-4" alt="Profile">
                        <h4 class="text-xl font-bold text-gray-900" id="dashboard-name"></h4>
                        <p class="text-orange-600 font-medium mb-1" id="dashboard-category"></p>
                        <p class="text-gray-600 text-sm" id="dashboard-location"></p>
                    </div>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Hourly Rate:</span>
                            <span class="font-bold text-gray-900" id="dashboard-rate"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="font-bold text-green-600" id="dashboard-status">Active</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Member Since:</span>
                            <span class="font-medium text-gray-900" id="dashboard-member-since"></span>
                        </div>
                    </div>
                    <button onclick="editProfile()" class="pill-btn w-full bg-orange-600 text-white py-3 mt-6 font-bold hover:bg-orange-700 transition">
                        Edit Profile
                    </button>
                </div>

                <!-- Recent Reviews -->
                <div class="chart-container lg:col-span-2">
                    <h3 class="text-xl font-bold heading-font text-gray-900 mb-6">Recent Reviews</h3>
                    <div id="dashboard-reviews" class="space-y-4 max-h-96 overflow-y-auto">
                        <!-- Populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Tips Section -->
            <div class="chart-container mt-6">
                <h3 class="text-xl font-bold heading-font text-gray-900 mb-4">üí° Tips to Improve Your Business</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="p-4 bg-blue-50 rounded-xl">
                        <h4 class="font-bold text-blue-900 mb-2">üì∏ Update Your Photo</h4>
                        <p class="text-sm text-blue-800">Profiles with photos get 3x more views</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-xl">
                        <h4 class="font-bold text-green-900 mb-2">‚≠ê Encourage Reviews</h4>
                        <p class="text-sm text-green-800">Ask satisfied customers to leave reviews</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-xl">
                        <h4 class="font-bold text-purple-900 mb-2">‚ö° Quick Responses</h4>
                        <p class="text-sm text-purple-800">Respond to WhatsApp messages within 1 hour</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyC4kR_HiywObXho8Zh20JyzC40iVrZq3lo",
            authDomain: "kasifix-5b102.firebaseapp.com",
            projectId: "kasifix-5b102",
            storageBucket: "kasifix-5b102.firebasestorage.app",
            messagingSenderId: "800882399249",
            appId: "1:800882399249:web:f8ecdfb12fa98d7a5779b0"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let allHustlers = [];
        let categories = new Set();
        let currentHustlerId = null;
        let currentUser = null;
        let currentUserHustlerData = null;

        // Admin emails (you can add more)
        const ADMIN_EMAILS = ['admin@kasifix.com', 'your-email@gmail.com'];

        db.ref('hustlers').on('value', snapshot => {
            allHustlers = [];
            categories.clear();

            const data = snapshot.val() || {};
            Object.entries(data).forEach(([id, h]) => {
                const hustler = { id, ...h };
                if (hustler.verified === true) {
                    allHustlers.push(hustler);
                    if (hustler.category) categories.add(hustler.category.trim());
                }
            });

            populateCategorySelect();
            renderAllHustlers(allHustlers);
        });

        function populateCategorySelect() {
            const select = document.getElementById('search-category');
            select.innerHTML = '<option value="">All Categories</option>';
            [...categories].sort().forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                select.appendChild(opt);
            });
        }

        function filterHustlers() {
            const keyword   = document.getElementById('search-keyword').value.toLowerCase().trim();
            const location  = document.getElementById('search-location').value.toLowerCase().trim();
            const category  = document.getElementById('search-category').value;
            const minRate   = Number(document.getElementById('search-min-rate').value) || 0;
            const verifiedOnly = document.getElementById('search-verified-only').checked;

            const filtered = allHustlers.filter(h => {
                const searchText = [
                    (h.name || '').toLowerCase(),
                    (h.category || '').toLowerCase(),
                    (h.location || '').toLowerCase(),
                    (h.bio || '').toLowerCase()
                ].join(' ');

                const matchesKeyword = !keyword || searchText.includes(keyword);
                const matchesLocation = !location || (h.location || '').toLowerCase().includes(location);
                const matchesCategory = !category || h.category === category;
                const matchesRate     = minRate === 0 || Number(h.rate || 0) >= minRate;
                const matchesVerified = !verifiedOnly || h.verified === true;

                return matchesKeyword && matchesLocation && matchesCategory && matchesRate && matchesVerified;
            });

            renderAllHustlers(filtered);
        }

        function renderAllHustlers(hustlers) {
            const container = document.getElementById('hustlers-grid');
            container.innerHTML = '';

            if (hustlers.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-20 text-gray-600">
                        <i class="fa-solid fa-search text-6xl mb-6 text-gray-300"></i>
                        <p class="text-xl">No matching hustlers found.<br>Try adjusting your filters.</p>
                    </div>`;
                return;
            }

            hustlers.slice(0, 12).forEach(h => {
                container.innerHTML += createHustlerCard(h);
            });
        }

        function createHustlerCard(h) {
            const rating = h.rating || 4.8;
            const reviews = h.reviews || Math.floor(Math.random() * 80 + 20);

            return `
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-hover border border-gray-100 cursor-pointer"
                 onclick="showHustlerDetail('${h.id}')">
                <div class="p-6">
                    <div class="flex items-center mb-4">
                        ${h.imageUrl ? 
                            `<img src="${h.imageUrl}" alt="${h.name}" class="w-16 h-16 rounded-full object-cover mr-4 ring-2 ring-[#f97316]/30">` :
                            `<div class="w-16 h-16 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-2xl font-bold text-gray-600 mr-4">
                                ${h.name ? h.name.charAt(0).toUpperCase() : '?'}
                            </div>`
                        }
                        <div>
                            <h3 class="font-bold text-lg text-gray-900">${h.name || 'Unnamed'}</h3>
                            <p class="text-[#f97316] font-medium">${h.category || '‚Äî'}</p>
                        </div>
                    </div>

                    <div class="flex items-center mb-3">
                        <div class="rating-stars flex">
                            ${Array(5).fill().map((_, i) => 
                                `<i class="fa-solid fa-star ${i < Math.floor(rating) ? 'text-yellow-400' : (i === Math.floor(rating) && rating % 1 >= 0.5 ? 'text-yellow-400/70' : 'text-gray-300')}"></i>`
                            ).join('')}
                        </div>
                        <span class="ml-2 text-sm text-gray-600">(${rating} ‚Ä¢ ${reviews} reviews)</span>
                    </div>

                    <p class="text-gray-600 mb-5 line-clamp-3">${h.bio || 'No bio available.'}</p>
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-xl text-gray-900">R${h.rate || '‚Äî'}/hr</span>
                        <span class="text-green-600 text-sm font-medium">Chat on WhatsApp ‚Üí</span>
                    </div>
                </div>
            </div>`;
        }

        function showHustlerDetail(id) {
            const hustler = allHustlers.find(h => h.id === id);
            if (!hustler) return;

            currentHustlerId = id;

            // Track profile view
            trackProfileView(id);

            const rating = hustler.rating || 4.8;
            const reviews = hustler.reviews || Math.floor(Math.random() * 80 + 20);

            const content = document.getElementById('hustler-detail-content');
            content.innerHTML = `
                <div class="text-center mb-6">
                    ${hustler.imageUrl ? 
                        `<img src="${hustler.imageUrl}" alt="${hustler.name}" class="w-32 h-32 rounded-full object-cover mx-auto ring-4 ring-[#f97316]/30 mb-4">` :
                        `<div class="w-32 h-32 rounded-full bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center text-5xl font-bold text-gray-600 mx-auto mb-4">
                            ${hustler.name ? hustler.name.charAt(0).toUpperCase() : '?'}
                        </div>`
                    }
                    <h2 class="text-3xl font-bold heading-font text-gray-900">${hustler.name || 'Unnamed Hustler'}</h2>
                    <p class="text-xl text-[#f97316] font-medium mt-1">${hustler.category || 'Service Provider'}</p>

                    <div class="flex items-center justify-center mt-3">
                        <div class="rating-stars flex text-2xl">
                            ${Array(5).fill().map((_, i) => 
                                `<i class="fa-solid fa-star ${i < Math.floor(rating) ? 'text-yellow-400' : (i === Math.floor(rating) && rating % 1 >= 0.5 ? 'text-yellow-400/70' : 'text-gray-300')}"></i>`
                            ).join('')}
                        </div>
                        <span class="ml-3 text-lg font-medium text-gray-600">(${rating} ‚Ä¢ ${reviews} reviews)</span>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div>
                        <p class="text-gray-500 text-sm">Location</p>
                        <p class="font-medium">${hustler.location || 'Not specified'}</p>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Hourly Rate</p>
                        <p class="font-bold text-xl">R${hustler.rate || '‚Äî'}/hr</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-xl font-bold mb-3">About Me</h3>
                    <p class="text-gray-700 whitespace-pre-line">${hustler.bio || 'No detailed bio provided yet.'}</p>
                </div>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <a href="https://wa.me/${(hustler.phone || '').replace(/\D/g,'')}" target="_blank" 
                       onclick="trackContactClick('${id}')"
                       class="pill-btn bg-green-600 text-white px-8 py-4 rounded-full font-bold hover:bg-green-700 transition flex items-center justify-center shadow">
                        <i class="fab fa-whatsapp mr-3 text-xl"></i> Chat on WhatsApp
                    </a>
                    <button onclick="document.getElementById('hustler-detail-modal').classList.add('hidden')"
                            class="pill-btn bg-gray-200 text-gray-800 px-8 py-4 rounded-full font-bold hover:bg-gray-300 transition">
                        Close
                    </button>
                </div>
            `;

            loadReviews(id);
            setupReviewForm(id);
            document.getElementById('hustler-detail-modal').classList.remove('hidden');
        }

        function showFirstHustlerInCategory(category) {
            const hustler = allHustlers.find(h => h.category === category && h.verified === true);

            if (hustler) {
                showHustlerDetail(hustler.id);
            } else {
                const content = document.getElementById('hustler-detail-content');
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fa-solid fa-exclamation-circle text-6xl text-gray-400 mb-6"></i>
                        <h2 class="text-2xl font-bold heading-font text-gray-900 mb-4">No Hustlers Found</h2>
                        <p class="text-lg text-gray-600">There are currently no verified ${category.toLowerCase()} hustlers available in your area.</p>
                        <button onclick="document.getElementById('hustler-detail-modal').classList.add('hidden')"
                                class="mt-6 pill-btn bg-gray-200 text-gray-800 px-8 py-4 rounded-full font-bold hover:bg-gray-300 transition">
                            Close
                        </button>
                    </div>
                `;
                document.getElementById('hustler-detail-modal').classList.remove('hidden');
            }
        }

        // Analytics tracking functions
        function trackProfileView(hustlerId) {
            const today = new Date().toISOString().split('T')[0];
            db.ref(`analytics/${hustlerId}/views/${today}`).transaction(current => (current || 0) + 1);
        }

        function trackContactClick(hustlerId) {
            const today = new Date().toISOString().split('T')[0];
            db.ref(`analytics/${hustlerId}/contacts/${today}`).transaction(current => (current || 0) + 1);
        }

        // Reviews functionality
        function loadReviews(hustlerId) {
            db.ref(`reviews/${hustlerId}`).once('value', snapshot => {
                const reviewsList = document.getElementById('reviews-list');
                reviewsList.innerHTML = '';

                const reviews = [];
                snapshot.forEach(child => {
                    reviews.push({ id: child.key, ...child.val() });
                });

                if (reviews.length === 0) {
                    reviewsList.innerHTML = '<p class="text-gray-500 text-center py-4">No reviews yet. Be the first to review!</p>';
                    return;
                }

                reviews.sort((a, b) => b.timestamp - a.timestamp).forEach(review => {
                    const reviewDiv = document.createElement('div');
                    reviewDiv.className = 'review-item';
                    reviewDiv.innerHTML = `
                        <div class="flex items-start justify-between mb-2">
                            <div>
                                <p class="font-bold text-gray-900">${review.name || 'Anonymous'}</p>
                                <div class="rating-stars flex text-sm">
                                    ${Array(5).fill().map((_, i) => 
                                        `<i class="fa-solid fa-star ${i < review.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`
                                    ).join('')}
                                </div>
                            </div>
                            <span class="text-xs text-gray-500">${new Date(review.timestamp).toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-700">${review.comment}</p>
                    `;
                    reviewsList.appendChild(reviewDiv);
                });
            });
        }

        function setupReviewForm(hustlerId) {
            const stars = document.querySelectorAll('#review-rating i');
            const selectedRating = document.getElementById('selected-rating');

            stars.forEach(star => {
                star.onclick = () => {
                    const rating = parseInt(star.dataset.rating);
                    selectedRating.value = rating;

                    stars.forEach((s, i) => {
                        if (i < rating) {
                            s.classList.remove('fa-regular');
                            s.classList.add('fa-solid');
                        } else {
                            s.classList.remove('fa-solid');
                            s.classList.add('fa-regular');
                        }
                    });
                };
            });

            document.getElementById('review-form').onsubmit = (e) => {
                e.preventDefault();
                const rating = parseInt(selectedRating.value);
                const comment = document.getElementById('review-comment').value.trim();
                const name = document.getElementById('review-name').value.trim();

                if (rating === 0) {
                    alert('Please select a rating');
                    return;
                }

                if (!comment) {
                    alert('Please write a review');
                    return;
                }

                const reviewData = {
                    rating,
                    comment,
                    name: name || 'Anonymous',
                    timestamp: Date.now()
                };

                db.ref(`reviews/${hustlerId}`).push(reviewData)
                    .then(() => {
                        alert('Thank you for your review!');
                        document.getElementById('review-form').reset();
                        selectedRating.value = 0;
                        stars.forEach(s => {
                            s.classList.remove('fa-solid');
                            s.classList.add('fa-regular');
                        });
                        loadReviews(hustlerId);
                        updateHustlerRating(hustlerId);
                    })
                    .catch(err => alert('Error submitting review: ' + err.message));
            };
        }

        function updateHustlerRating(hustlerId) {
            db.ref(`reviews/${hustlerId}`).once('value', snapshot => {
                let totalRating = 0;
                let count = 0;

                snapshot.forEach(child => {
                    totalRating += child.val().rating;
                    count++;
                });

                if (count > 0) {
                    const avgRating = (totalRating / count).toFixed(1);
                    db.ref(`hustlers/${hustlerId}`).update({
                        rating: parseFloat(avgRating),
                        reviews: count
                    });
                }
            });
        }

        // Cloudinary Upload
        const CLOUD_NAME    = 'dv5bsbydu';
        const UPLOAD_PRESET = 'admin_tlaka';
        const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

        document.getElementById('profile-photo').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('progress-container').classList.remove('hidden');
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-text').classList.remove('hidden');
            document.getElementById('progress-text').textContent = 'Uploading... 0%';
            document.getElementById('photo-preview').classList.add('hidden');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', CLOUDINARY_URL, true);

            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    document.getElementById('progress-bar').style.width = percentComplete + '%';
                    document.getElementById('progress-text').textContent = `Uploading... ${percentComplete}%`;
                }
            };

            xhr.onload = function() {
                if (xhr.status === 200) {
                    const data = JSON.parse(xhr.responseText);
                    if (data.secure_url) {
                        document.getElementById('imageUrlField').value = data.secure_url;
                        document.getElementById('preview-img').src = data.secure_url;
                        document.getElementById('photo-preview').classList.remove('hidden');
                        document.getElementById('progress-text').textContent = 'Upload complete!';
                        setTimeout(() => {
                            document.getElementById('progress-container').classList.add('hidden');
                            document.getElementById('progress-text').classList.add('hidden');
                        }, 1800);
                    } else {
                        alert('Upload failed: ' + (data.error?.message || 'Unknown error'));
                        resetProgress();
                    }
                } else {
                    alert('Server error: ' + xhr.status);
                    resetProgress();
                }
            };

            xhr.onerror = function() {
                alert('Network error during upload');
                resetProgress();
            };

            xhr.send(formData);
        });

        function resetProgress() {
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('progress-text').classList.add('hidden');
        }

        document.getElementById('hustler-signup-form').addEventListener('submit', e => {
            e.preventDefault();
            const form = e.target;

            if (!form.imageUrl.value && !confirm('No photo uploaded. Continue without profile picture?')) {
                return;
            }

            const data = {
                name: form.name.value.trim(),
                email: form.email.value.trim(),
                phone: form.phone.value.trim(),
                category: form.category.value.trim(),
                rate: Number(form.rate.value) || 0,
                location: form.location.value.trim(),
                bio: form.bio.value.trim(),
                imageUrl: form.imageUrl.value.trim() || null,
                verified: false,
                featured: false,
                createdAt: Date.now()
            };

            db.ref('hustlers').push(data)
                .then(() => {
                    alert('Thank you! Your profile has been submitted for review. You will receive an email when approved.');
                    form.reset();
                    document.getElementById('photo-preview').classList.add('hidden');
                    resetProgress();
                    document.getElementById('hustler-signup-modal').classList.add('hidden');
                })
                .catch(err => alert('Error submitting profile: ' + err.message));
        });

        // Authentication
        const hustlerLoginBtn = document.getElementById('hustler-login-btn');

        hustlerLoginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    currentUser = result.user;
                    checkUserRole(currentUser);
                })
                .catch((error) => {
                    console.error("Google sign-in error:", error);
                    alert("Login failed: " + error.message);
                });
        });

        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
            }
        });

        function checkUserRole(user) {
            // Check if admin
            if (ADMIN_EMAILS.includes(user.email)) {
                showAdminDashboard();
                return;
            }

            // Check if registered hustler
            db.ref('hustlers').orderByChild('email').equalTo(user.email).once('value', snapshot => {
                if (snapshot.exists()) {
                    const hustlerData = Object.entries(snapshot.val())[0];
                    currentUserHustlerData = { id: hustlerData[0], ...hustlerData[1] };
                    
                    if (currentUserHustlerData.verified) {
                        showHustlerDashboard(currentUserHustlerData);
                    } else {
                        alert('Your profile is pending verification. You will receive an email when approved.');
                        goBackToHome();
                    }
                } else {
                    alert('No hustler profile found for this email. Please sign up first.');
                    goBackToHome();
                }
            });
        }

        function showAdminDashboard() {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('admin-dashboard-page').style.display = 'block';
            loadPendingHustlers();
        }

        function loadPendingHustlers() {
            db.ref('hustlers').orderByChild('verified').equalTo(false).on('value', snapshot => {
                const container = document.getElementById('pending-hustlers');
                container.innerHTML = '';

                if (!snapshot.exists()) {
                    container.innerHTML = '<div class="col-span-full text-center py-10 text-gray-500">No pending applications</div>';
                    return;
                }

                snapshot.forEach(child => {
                    const h = child.val();
                    const id = child.key;

                    container.innerHTML += `
                        <div class="bg-white rounded-xl shadow-md p-6 border border-gray-200">
                            <div class="flex items-center mb-4">
                                ${h.imageUrl ? 
                                    `<img src="${h.imageUrl}" class="w-16 h-16 rounded-full object-cover mr-4">` :
                                    `<div class="w-16 h-16 rounded-full bg-gray-300 flex items-center justify-center text-2xl font-bold text-gray-600 mr-4">${h.name.charAt(0)}</div>`
                                }
                                <div>
                                    <h3 class="font-bold text-lg">${h.name}</h3>
                                    <p class="text-orange-600">${h.category}</p>
                                </div>
                            </div>
                            <div class="mb-4 text-sm space-y-1">
                                <p><strong>Email:</strong> ${h.email || 'N/A'}</p>
                                <p><strong>Phone:</strong> ${h.phone}</p>
                                <p><strong>Location:</strong> ${h.location}</p>
                                <p><strong>Rate:</strong> R${h.rate}/hr</p>
                                <p><strong>Bio:</strong> ${h.bio || 'N/A'}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="approveHustler('${id}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg font-bold hover:bg-green-700">
                                    Approve
                                </button>
                                <button onclick="rejectHustler('${id}')" class="flex-1 bg-red-600 text-white py-2 rounded-lg font-bold hover:bg-red-700">
                                    Reject
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
        }

        function approveHustler(id) {
            if (confirm('Approve this hustler?')) {
                db.ref(`hustlers/${id}`).update({ verified: true })
                    .then(() => alert('Hustler approved!'))
                    .catch(err => alert('Error: ' + err.message));
            }
        }

        function rejectHustler(id) {
            if (confirm('Reject and delete this application?')) {
                db.ref(`hustlers/${id}`).remove()
                    .then(() => alert('Application rejected'))
                    .catch(err => alert('Error: ' + err.message));
            }
        }

        function showHustlerDashboard(hustlerData) {
            document.getElementById('main-content').classList.add('hidden');
            document.getElementById('hustler-dashboard-page').style.display = 'block';
            
            populateHustlerDashboard(hustlerData);
        }

        function populateHustlerDashboard(hustlerData) {
            // Set basic info
            document.getElementById('hustler-name-nav').textContent = hustlerData.name;
            document.getElementById('hustler-name-header').textContent = hustlerData.name.split(' ')[0];
            document.getElementById('dashboard-name').textContent = hustlerData.name;
            document.getElementById('dashboard-category').textContent = hustlerData.category;
            document.getElementById('dashboard-location').textContent = hustlerData.location;
            document.getElementById('dashboard-rate').textContent = `R${hustlerData.rate}/hr`;
            
            if (hustlerData.imageUrl) {
                document.getElementById('dashboard-profile-pic').src = hustlerData.imageUrl;
            } else {
                document.getElementById('dashboard-profile-pic').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(hustlerData.name)}&size=200&background=f97316&color=fff&bold=true`;
            }

            document.getElementById('dashboard-member-since').textContent = 
                new Date(hustlerData.createdAt || Date.now()).toLocaleDateString('en-ZA', { month: 'short', year: 'numeric' });

            // Load analytics
            loadHustlerAnalytics(hustlerData.id);
            
            // Load reviews
            loadDashboardReviews(hustlerData.id);

            // Calculate rank in category
            calculateCategoryRank(hustlerData);
        }

        function loadHustlerAnalytics(hustlerId) {
            // Get views for last 30 days
            db.ref(`analytics/${hustlerId}/views`).once('value', viewsSnapshot => {
                let totalViews = 0;
                let last7DaysViews = 0;
                let prev7DaysViews = 0;
                const today = new Date();
                const views7DaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const views14DaysAgo = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000);

                viewsSnapshot.forEach(child => {
                    const date = new Date(child.key);
                    const count = child.val();
                    totalViews += count;

                    if (date >= views7DaysAgo) {
                        last7DaysViews += count;
                    } else if (date >= views14DaysAgo) {
                        prev7DaysViews += count;
                    }
                });

                document.getElementById('stat-views').textContent = totalViews;
                
                const viewsChange = prev7DaysViews > 0 
                    ? Math.round(((last7DaysViews - prev7DaysViews) / prev7DaysViews) * 100)
                    : (last7DaysViews > 0 ? 100 : 0);
                
                document.getElementById('views-change').textContent = `${viewsChange}%`;

                // Create weekly chart
                createWeeklyChart(viewsSnapshot.val() || {});
            });

            // Get contacts
            db.ref(`analytics/${hustlerId}/contacts`).once('value', contactsSnapshot => {
                let totalContacts = 0;
                let last7DaysContacts = 0;
                let prev7DaysContacts = 0;
                const today = new Date();
                const contacts7DaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const contacts14DaysAgo = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000);

                contactsSnapshot.forEach(child => {
                    const date = new Date(child.key);
                    const count = child.val();
                    totalContacts += count;

                    if (date >= contacts7DaysAgo) {
                        last7DaysContacts += count;
                    } else if (date >= contacts14DaysAgo) {
                        prev7DaysContacts += count;
                    }
                });

                document.getElementById('stat-contacts').textContent = totalContacts;
                
                const contactsChange = prev7DaysContacts > 0 
                    ? Math.round(((last7DaysContacts - prev7DaysContacts) / prev7DaysContacts) * 100)
                    : (last7DaysContacts > 0 ? 100 : 0);
                
                document.getElementById('contacts-change').textContent = `${contactsChange}%`;
            });

            // Get rating
            db.ref(`reviews/${hustlerId}`).once('value', reviewsSnapshot => {
                let totalRating = 0;
                let reviewCount = 0;
                const ratingDistribution = [0, 0, 0, 0, 0];

                reviewsSnapshot.forEach(child => {
                    const rating = child.val().rating;
                    totalRating += rating;
                    reviewCount++;
                    ratingDistribution[rating - 1]++;
                });

                const avgRating = reviewCount > 0 ? (totalRating / reviewCount).toFixed(1) : 0;
                document.getElementById('stat-rating').textContent = avgRating;
                document.getElementById('total-reviews').textContent = reviewCount;

                createRatingChart(ratingDistribution);
            });
        }

        function createWeeklyChart(viewsData) {
            const ctx = document.getElementById('weeklyChart');
            if (!ctx) return;

            const last7Days = [];
            const viewCounts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(date.toLocaleDateString('en-ZA', { weekday: 'short' }));
                viewCounts.push(viewsData[dateStr] || 0);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Profile Views',
                        data: viewCounts,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function createRatingChart(distribution) {
            const ctx = document.getElementById('ratingChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1‚òÖ', '2‚òÖ', '3‚òÖ', '4‚òÖ', '5‚òÖ'],
                    datasets: [{
                        label: 'Number of Reviews',
                        data: distribution,
                        backgroundColor: [
                            '#ef4444',
                            '#f97316',
                            '#eab308',
                            '#84cc16',
                            '#22c55e'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        function loadDashboardReviews(hustlerId) {
            db.ref(`reviews/${hustlerId}`).once('value', snapshot => {
                const container = document.getElementById('dashboard-reviews');
                container.innerHTML = '';

                if (!snapshot.exists()) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">No reviews yet</p>';
                    return;
                }

                const reviews = [];
                snapshot.forEach(child => {
                    reviews.push(child.val());
                });

                reviews.sort((a, b) => b.timestamp - a.timestamp).slice(0, 5).forEach(review => {
                    container.innerHTML += `
                        <div class="p-4 bg-gray-50 rounded-xl">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-bold text-gray-900">${review.name || 'Anonymous'}</p>
                                    <div class="rating-stars flex text-sm">
                                        ${Array(5).fill().map((_, i) => 
                                            `<i class="fa-solid fa-star ${i < review.rating ? 'text-yellow-400' : 'text-gray-300'}"></i>`
                                        ).join('')}
                                    </div>
                                </div>
                                <span class="text-xs text-gray-500">${new Date(review.timestamp).toLocaleDateString()}</span>
                            </div>
                            <p class="text-gray-700 text-sm">${review.comment}</p>
                        </div>
                    `;
                });
            });
        }

        function calculateCategoryRank(hustlerData) {
            db.ref('hustlers').orderByChild('category').equalTo(hustlerData.category).once('value', snapshot => {
                const categoryHustlers = [];
                snapshot.forEach(child => {
                    if (child.val().verified) {
                        categoryHustlers.push({ id: child.key, ...child.val() });
                    }
                });

                // Sort by rating
                categoryHustlers.sort((a, b) => (b.rating || 0) - (a.rating || 0));
                
                const rank = categoryHustlers.findIndex(h => h.id === hustlerData.id) + 1;
                
                document.getElementById('stat-rank').textContent = `#${rank}`;
                document.getElementById('category-total').textContent = categoryHustlers.length;
            });
        }

        function editProfile() {
            alert('Profile editing feature coming soon!');
        }

        function goBackToHome() {
            document.getElementById('admin-dashboard-page').style.display = 'none';
            document.getElementById('hustler-dashboard-page').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            currentUser = null;
            currentUserHustlerData = null;
        }

        // Initial render
        renderAllHustlers([]);
    </script>
</body>
</html>
